<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bookings Table</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f2f5;
      display: flex;
      align-items: flex-start;
      min-height: 100vh;
      padding: 2rem;
      box-sizing: border-box;
    }
    .icon-check {
      color: #10B981;
      font-size: 1.25rem;
    }
    .icon-cross {
      color: #EF4444;
      font-size: 1.25rem;
    }
    .container {
      max-width: 100vw;
      margin: 40px auto;
      padding: 24px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow-x: auto;
    }
    h1 {
      text-align: center;
      margin-bottom: 2rem;
      color: #1a237e;
    }
    table {
      width: 100%;
      min-width: 1100px;
      border-collapse: collapse;
      margin: 2rem 0;
      background: #fff;
      font-size: 1rem;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #e0e0e0;
      padding: 0.6rem 0.5rem;
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: bold;
    }
    th {
      background: #e3f0fb;
      color: #0d47a1;
      font-weight: 600;
    }
    th.booking { min-width: 90px; width: 90px; }
    th.tourdate { min-width: 110px; width: 110px; }
    th.customername { min-width: 160px; width: 160px; }
    th.sku { min-width: 80px; width: 80px; }
    th.program { min-width: 120px; width: 120px; }
    th.hotel { min-width: 120px; width: 120px; }
    th.op, th.ri, th.customer, th.adult, th.child, th.infant {
      min-width: 50px; width: 50px; text-align: center;
    }
    td.op, td.ri, td.customer, td.adult, td.child, td.infant {
      text-align: center;
    }
    .icon-true {
      color: #388e3c;
      font-weight: bold;
      font-size: 1.2em;
    }
    .icon-false {
      color: #d32f2f;
      font-weight: bold;
      font-size: 1.2em;
    }
    tr:nth-child(even) td {
      background: #f7fbff;
    }
    tr:hover td {
      background: #bbdefb;
      color: #0d47a1;
    }
    @media (max-width: 1200px) {
      table { min-width: 900px; }
    }
    @media (max-width: 700px) {
      .container { padding: 8px; }
      table, th, td { font-size: 0.92rem; }
      #bookings-table { min-width: unset; display: none; }
      .bookings-table-container .overflow-x-auto { display: none; }
      .booking-cards { display: block; }
      .accounting-table { display: table !important; min-width: 700px; }
    }
    .booking-cards { display: none; }
    table tr.row-past td { color: #d32f2f !important; }
    table tr.row-today td { color: #1b5e20 !important; background: #e8f5e9 !important; }
    table tr.row-tomorrow td { color: #b59b00 !important; background: #fffde7 !important; }
    .card-row-past { color: #d32f2f !important; background: #ffebee !important; }
    .card-row-today { color: #1b5e20 !important; background: #e8f5e9 !important; }
    .card-row-tomorrow { color: #b59b00 !important; background: #fffde7 !important; }
  </style>
</head>
<body class="antialiased">
  <div class="w-full bg-white p-6 md:p-8 rounded-xl shadow-lg">
    <!-- Today's Date and Time (Bangkok) -->
    <div class="flex justify-center mb-2">
      <span id="bangkok-datetime" class="text-base md:text-lg font-semibold text-indigo-700 bg-indigo-50 rounded px-4 py-1 shadow-sm"></span>
    </div>
    <!-- Table Toggle Section -->
    <div class="mb-4 flex justify-center gap-4">
      <button id="toggle-dashboard" class="px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800" type="button">Dashboard</button>
      <button id="toggle-bookings" class="px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800" type="button">Bookings</button>
      <button id="toggle-programs" class="px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800" type="button">Programs</button>
      <button id="toggle-accounting" class="px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800" type="button">Accounting</button>
    </div>
    <!-- Programs Table Section (hidden by default) -->
    <div id="programs-section" style="display:none;">
      <div class="mb-4 flex justify-between items-center">
        <h2 class="text-xl font-bold text-indigo-800">Programs</h2>
        <button id="add-program-btn" class="px-3 py-1 rounded bg-green-600 text-white font-semibold">+ Add Program</button>
      </div>
      <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
        <table id="programs-table" class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2">SKU</th>
              <th class="px-3 py-2">ID</th>
              <th class="px-3 py-2">Program</th>
              <th class="px-3 py-2">Rate</th>
              <th class="px-3 py-2">Net Adult</th>
              <th class="px-3 py-2">Net Child</th>
              <th class="px-3 py-2">NP</th>
              <th class="px-3 py-2">NP Adult</th>
              <th class="px-3 py-2">NP Child</th>
              <th class="px-3 py-2">Remark</th>
              <th class="px-3 py-2">Actions</th>
            </tr>
          </thead>
          <tbody id="programs-table-body">
            <tr><td colspan="11" style="text-align:center;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Search Bar Section -->
    <div class="mb-6">
      <label for="search-bar" class="sr-only">Search bookings</label>
      <div class="relative">
        <button id="clear-search-btn" type="button" style="display:none;" class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400 hover:text-red-500 focus:outline-none z-10" title="Clear search">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <input id="search-bar" type="text" placeholder="Search bookings..." class="w-full px-5 py-3 pl-10 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-700 placeholder-gray-400 text-base">
        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-blue-600 focus:outline-none" tabindex="-1" style="pointer-events:none; background:transparent; border:none;">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </button>
      </div>
    </div>
    <!-- Results Summary Section -->
    <div id="table-summary" class="text-center mb-6"></div>
    <div id="booking-cards-container" class="booking-cards"></div>
    <hr class="border-gray-200 mb-6">
    <!-- Bookings Table Section -->
    <div class="bookings-table-container overflow-x-auto rounded-lg shadow-md border border-gray-200">
      <table id="bookings-table" class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th data-col="booking_number" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking #</th>
            <th data-col="tour_date" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tour Date</th>
            <th data-col="customer_name" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
            <th data-col="sku" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
            <th data-col="program" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
            <th data-col="hotel" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hotel</th>
            <th data-col="op" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">OP</th>
            <th data-col="ri" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">RI</th>
            <th data-col="customer" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
            <th data-col="adult" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Adult</th>
            <th data-col="child" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Child</th>
            <th data-col="infant" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Infant</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Copy</th>
        </tr>
      </thead>
        <tbody id="bookings-body" class="bg-white divide-y divide-gray-200">
        <tr><td colspan="12" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>
    </div>
    <hr class="border-gray-200 mt-6 mb-6">
    <div id="pagination-controls" class="flex justify-center items-center space-x-2 text-base"></div>
    <div id="accounting-table-container" style="display:none;">
      <div id="accounting-summary" class="text-center mb-6" style="display:none;"></div>
      <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
        <table id="accounting-table" class="accounting-table min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th data-col="booking_number" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Booking #</th>
              <th data-col="tour_date" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tour Date</th>
              <th data-col="customer_name" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer Name</th>
              <th data-col="sku" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
              <th data-col="program" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Program</th>
              <th data-col="hotel" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hotel</th>
              <th data-col="paid" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Cancel</th>
            </tr>
          </thead>
          <tbody id="accounting-body" class="bg-white divide-y divide-gray-200">
            <tr><td colspan="8" style="text-align:center;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
      <div id="accounting-pagination-controls" class="flex justify-center items-center space-x-2 text-base mt-4"></div>
    </div>
    <!-- Dashboard Section (hidden by default) -->
    <div id="dashboard-section" style="display:none;">
      <div class="flex flex-wrap gap-4 justify-center mb-6">
        <div class="bg-indigo-50 rounded-lg p-4 min-w-[220px] text-center shadow">
          <div class="text-sm text-indigo-700 font-semibold mb-1">Total Bookings</div>
          <div id="dashboard-total-bookings" class="text-2xl font-bold text-indigo-900">-</div>
          <div id="dashboard-total-bookings-change" class="text-xs mt-1"></div>
        </div>
        <div class="bg-pink-50 rounded-lg p-4 min-w-[220px] text-center shadow">
          <div class="text-sm text-pink-700 font-semibold mb-1">New Bookings</div>
          <div id="dashboard-new-bookings" class="text-2xl font-bold text-pink-900">-</div>
          <div id="dashboard-new-bookings-change" class="text-xs mt-1"></div>
        </div>
        <div class="bg-green-50 rounded-lg p-4 min-w-[220px] text-center shadow">
          <div class="text-sm text-green-700 font-semibold mb-1">Total Earnings</div>
          <div id="dashboard-total-earnings" class="text-2xl font-bold text-green-900">-</div>
          <div id="dashboard-total-earnings-change" class="text-xs mt-1"></div>
        </div>
        <div class="bg-blue-50 rounded-lg p-4 min-w-[220px] text-center shadow">
          <div class="text-sm text-blue-700 font-semibold mb-1">Done vs Booked</div>
          <div class="flex items-center justify-center gap-2 mt-2">
            <div id="dashboard-done" class="font-bold text-blue-900">-</div>
            <span class="text-xs text-gray-500">/</span>
            <div id="dashboard-booked" class="font-bold text-blue-700">-</div>
          </div>
          <div class="w-full bg-gray-200 rounded h-2 mt-2">
            <div id="dashboard-progress" class="bg-blue-500 h-2 rounded" style="width:0%"></div>
          </div>
        </div>
      </div>
      <div class="flex flex-wrap gap-8 justify-center mb-6">
        <div class="bg-white rounded-lg p-4 shadow min-w-[320px]">
          <div class="flex justify-between items-center mb-2">
            <div class="text-base font-semibold text-indigo-800">Revenue by Day</div>
            <select id="dashboard-period" class="border rounded px-2 py-1 text-sm">
              <option value="thisMonth">This Month</option>
              <option value="lastMonth">Last Month</option>
              <option value="all">All Time</option>
            </select>
          </div>
          <div id="dashboard-revenue-list" class="text-sm"></div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow min-w-[220px]">
          <div class="text-base font-semibold text-indigo-800 mb-2">Top Destinations</div>
          <div id="dashboard-top-destinations" class="text-sm"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    function iconButton(column, bookingId, value) {
      const icon = (value === true || value === 1 || value === '1' || value === 'true') ? '✅' : '❌';
      const title = (value === true || value === 1 || value === '1' || value === 'true') ? 'Yes' : 'No';
      const btnClass = (icon === '✅') ? 'icon-btn icon-true' : 'icon-btn icon-false';
      return `<button class="${btnClass}" title="${title}" onclick="handleToggle('${column}', '${bookingId}', this)">${icon}</button>`;
    }
    function isBoolLike(val) {
      if (typeof val === 'boolean') return true;
      if (typeof val === 'number') return val === 0 || val === 1;
      if (typeof val === 'string') return ['0','1','true','false'].includes(val.toLowerCase());
      return false;
    }

    // Pagination variables
    let currentPage = 1;
    const rowsPerPage = 20;
    let totalRows = 0;
    let bookingsData = [];
    let currentSort = 'tour_date';
    let currentDir = 'desc';
    let searchTerm = '';
    let todayCount = 0;
    let todayOpNotSent = 0;
    let todayCustomerNotSent = 0;
    let tomorrowCount = 0;
    let tomorrowOpNotSent = 0;
    let tomorrowCustomerNotSent = 0;
    let bookingsSummaryData = null;
    let bookingsSummaryDataUnfiltered = null;
    let bookingsSummaryLoading = false;
    let currentBangkokDate = null;

    async function fetchBookings(page = 1, sort = currentSort, dir = currentDir, search = searchTerm, keepSummary = false) {
      const tbody = document.getElementById('bookings-body');
      const summaryDiv = document.getElementById('table-summary');
      // Always fetch unfiltered summary stats once (for default display)
      if (!bookingsSummaryDataUnfiltered) {
        bookingsSummaryLoading = true;
        renderTable();
        fetch('/api/bookings?page=1&limit=1')
          .then(res => res.json())
          .then(summaryData => {
            bookingsSummaryDataUnfiltered = {
              todayCount: summaryData.todayCount || 0,
              todayOpNotSent: summaryData.todayOpNotSent || 0,
              todayCustomerNotSent: summaryData.todayCustomerNotSent || 0,
              tomorrowCount: summaryData.tomorrowCount || 0,
              tomorrowOpNotSent: summaryData.tomorrowOpNotSent || 0,
              tomorrowCustomerNotSent: summaryData.tomorrowCustomerNotSent || 0,
              dayAfterTomorrowCount: summaryData.dayAfterTomorrowCount || 0,
              dayAfterTomorrowOpNotSent: summaryData.dayAfterTomorrowOpNotSent || 0,
              dayAfterTomorrowCustomerNotSent: summaryData.dayAfterTomorrowCustomerNotSent || 0
            };
            if (!search) {
              bookingsSummaryData = bookingsSummaryDataUnfiltered;
              bookingsSummaryLoading = false;
              renderTable();
            }
          });
      }
      // If searching, fetch filtered summary stats
      if (search) {
        bookingsSummaryLoading = true;
        renderTable();
        const summaryParams = new URLSearchParams({ page: 1, limit: 1 });
        if (search) summaryParams.append('search', search);
        fetch(`/api/bookings?${summaryParams.toString()}`)
          .then(res => res.json())
          .then(summaryData => {
            bookingsSummaryData = {
              todayCount: summaryData.todayCount || 0,
              todayOpNotSent: summaryData.todayOpNotSent || 0,
              todayCustomerNotSent: summaryData.todayCustomerNotSent || 0,
              tomorrowCount: summaryData.tomorrowCount || 0,
              tomorrowOpNotSent: summaryData.tomorrowOpNotSent || 0,
              tomorrowCustomerNotSent: summaryData.tomorrowCustomerNotSent || 0,
              dayAfterTomorrowCount: summaryData.dayAfterTomorrowCount || 0,
              dayAfterTomorrowOpNotSent: summaryData.dayAfterTomorrowOpNotSent || 0,
              dayAfterTomorrowCustomerNotSent: summaryData.dayAfterTomorrowCustomerNotSent || 0
            };
            bookingsSummaryLoading = false;
            renderTable();
          });
      } else if (bookingsSummaryDataUnfiltered) {
        bookingsSummaryData = bookingsSummaryDataUnfiltered;
        bookingsSummaryLoading = false;
        renderTable();
      }
      try {
        const params = new URLSearchParams({
          page,
          limit: rowsPerPage,
          sort,
          dir
        });
        if (search) params.append('search', search);
        const res = await fetch(`/api/bookings?${params.toString()}`);
        const data = await res.json();
        if (!data.bookings || !data.bookings.length) {
          tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;">No bookings found.</td></tr>';
          summaryDiv.textContent = 'No results.';
          document.getElementById('pagination-controls').innerHTML = '';
          bookingsData = [];
          totalRows = 0;
          return;
        }
        bookingsData = data.bookings;
        totalRows = data.total || bookingsData.length;
        currentPage = data.page || 1;
        renderTable();
        renderPagination();
        updateSortIndicators();
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; color:red;">Failed to load bookings.</td></tr>';
        document.getElementById('pagination-controls').innerHTML = '';
      }
    }

    function getRowClass(tourDateStr) {
      if (!tourDateStr) return '';
      // Parse as local date (not UTC)
      let d = tourDateStr.length >= 10 ? tourDateStr.substring(0, 10) : '';
      if (!/^\d{4}-\d{2}-\d{2}$/.test(d)) return '';
      const [year, month, day] = d.split('-').map(Number);
      const date = new Date(year, month - 1, day); // local date
      const today = new Date();
      today.setHours(0,0,0,0);
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      if (date < today) return 'row-past';
      if (date.getFullYear() === today.getFullYear() && date.getMonth() === today.getMonth() && date.getDate() === today.getDate()) return 'row-today';
      if (date.getFullYear() === tomorrow.getFullYear() && date.getMonth() === tomorrow.getMonth() && date.getDate() === tomorrow.getDate()) return 'row-tomorrow';
      return '';
    }

    function renderTable() {
      const tbody = document.getElementById('bookings-body');
      const summaryDiv = document.getElementById('table-summary');
      const cardsContainer = document.getElementById('booking-cards-container');
      // Hide cards by default
      cardsContainer.style.display = 'none';
      if (!bookingsData.length) {
        tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;">No bookings found.</td></tr>';
        cardsContainer.innerHTML = '';
      } else {
      tbody.innerHTML = bookingsData.map(b => `
          <tr class="${getRowClass(b.tour_date)}">
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${b.booking_number || ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">${b.tour_date ? b.tour_date.substring(0, 10) : ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">${b.customer_name || ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">${b.sku || ''}</td>
            <td class="px-4 py-3 text-sm">${b.program || ''}</td>
            <td class="px-4 py-3 text-sm">${b.hotel || ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center">${iconButton('op', b.booking_number, b.op)}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center">${iconButton('ri', b.booking_number, b.ri)}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center">${iconButton('customer', b.booking_number, b.customer)}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-center">${b.adult || ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-center">${b.child || ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-center">${b.infant || ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center"><button class="copy-btn" data-booking='${JSON.stringify(b).replace(/'/g, "&#39;")}' title="Copy notification text" onclick="handleCopy(this)">📋 Copy</button></td>
        </tr>
      `).join('');
        // Render cards for mobile
        cardsContainer.innerHTML = bookingsData.map(b => {
          const showChild = b.child && Number(b.child) > 0;
          const showInfant = b.infant && Number(b.infant) > 0;
          let cardClass = '';
          const rowClass = getRowClass(b.tour_date);
          if (rowClass === 'row-past') cardClass = 'card-row-past';
          else if (rowClass === 'row-today') cardClass = 'card-row-today';
          else if (rowClass === 'row-tomorrow') cardClass = 'card-row-tomorrow';
          return `
          <div class="rounded-lg shadow border mb-4 p-4 bg-white ${getRowClass(b.tour_date)} ${cardClass}">
            <div class="flex flex-wrap gap-x-4 gap-y-1 mb-2 items-center">
              <span class="font-bold">🆔 Booking #:</span> <span>${b.booking_number || ''}</span>
              <span class="font-bold ml-4">📅 Tour Date:</span> <span>${b.tour_date ? b.tour_date.substring(0, 10) : ''}</span>
            </div>
            <hr class="my-2">
            <div class="mb-1 flex items-center"><span class="font-bold">👤 Customer:</span> <span>${b.customer_name || ''}</span></div>
            <div class="mb-1 flex items-center"><span class="font-bold">📝Program:</span> <span style="margin-left:4px;">${(b.program || '').trim()}</span></div>
            <div class="mb-1 flex items-center"><span class="font-bold">🏨Hotel:</span> <span>${b.hotel || ''}</span></div>
            <hr class="my-2">
            <div class="flex flex-wrap gap-x-4 gap-y-1 mb-1 items-center">
              <span class="font-bold">OP:</span> ${iconButton('op', b.booking_number, b.op)}
              <span class="font-bold">RI:</span> ${iconButton('ri', b.booking_number, b.ri)}
              <span class="font-bold">Customer:</span> ${iconButton('customer', b.booking_number, b.customer)}
            </div>
            <hr class="my-2">
            <div class="flex flex-wrap gap-x-4 gap-y-1 items-center">
              <span class="font-bold">🧑 Adult:</span> ${b.adult || ''}
              ${showChild ? `<span class='font-bold'>🧒 Child:</span> ${b.child}` : ''}
              ${showInfant ? `<span class='font-bold'>👶 Infant:</span> ${b.infant}` : ''}
            </div>
            <div class="mt-2 text-right"><button class="copy-btn" data-booking='${JSON.stringify(b).replace(/'/g, "&#39;")}' title="Copy notification text" onclick="handleCopy(this)">📋 Copy</button></div>
          </div>
          `;
        }).join('');
      }
      // Show cards on mobile only
      if (window.innerWidth <= 700) {
        cardsContainer.style.display = 'block';
      } else {
        cardsContainer.style.display = 'none';
      }
      renderPagination();
      // Always render summary and pagination
      function statSpan(label, value, isGreen, extraClass = '') {
        return `<span class="${isGreen ? 'text-green-600' : 'text-red-600'} font-medium ${extraClass}">${label} <span class="font-bold ${isGreen ? 'text-green-700' : 'text-red-700'}">${value}</span></span>`;
      }
      function statCard(day, total, opNotSent, customerNotSent, color, bg, border, totalClass, id = "") {
        return `
        <div class="p-4 rounded-lg ${bg} shadow-sm border ${border} flex flex-col items-center justify-center cursor-pointer" id="${id}">
          <p class="${color} font-semibold mb-2 text-lg">${day}</p>
          <div class="flex flex-wrap justify-center gap-x-4 gap-y-2 text-gray-800">
            <span class="font-medium">Total: <span class="font-bold ${totalClass}">${total}</span></span>
            <span>|</span>
            ${statSpan('Not sent to OP:', opNotSent, opNotSent == 0)}
            <span>|</span>
            ${statSpan('Not sent to Customer:', customerNotSent, customerNotSent == 0, customerNotSent == 0 ? 'font-medium' : 'font-bold')}
          </div>
        </div>`;
      }
      // Use summary data from unfiltered fetch
      let summary = bookingsSummaryData;
      if (bookingsSummaryLoading) {
        summaryDiv.innerHTML = `<div class='flex justify-center items-center py-8'><span class='animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-700'></span> <span class='ml-3 text-gray-500 text-lg'>Loading summary...</span></div>`;
        return;
      }
      if (!summary) summary = { todayCount: 0, todayOpNotSent: 0, todayCustomerNotSent: 0, tomorrowCount: 0, tomorrowOpNotSent: 0, tomorrowCustomerNotSent: 0 };
      summaryDiv.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6 text-sm md:text-base">
          ${statCard('Tomorrow', summary.tomorrowCount, summary.tomorrowOpNotSent, summary.tomorrowCustomerNotSent, 'text-indigo-700', 'bg-indigo-50', 'border-indigo-100', 'text-indigo-800', 'tomorrow-card')}
          ${statCard('Day After Tomorrow', summary.dayAfterTomorrowCount || 0, summary.dayAfterTomorrowOpNotSent || 0, summary.dayAfterTomorrowCustomerNotSent || 0, 'text-teal-700', 'bg-teal-50', 'border-teal-100', 'text-teal-800', 'dayaftertomorrow-card')}
        </div>
        <div class="flex justify-end mt-4">
          <span class="text-xs text-gray-500">Showing <span class="font-semibold text-gray-800">${bookingsData.length}</span> of <span class="font-semibold text-gray-800">${totalRows}</span> results <span class="text-xs text-gray-400 ml-1">(Page ${currentPage})</span></span>
        </div>
      `;
      renderPagination();
      // Attach click event to Tomorrow card (Bangkok time)
      const tomorrowCard = document.getElementById('tomorrow-card');
      if (tomorrowCard) {
        tomorrowCard.onclick = function() {
          const tomorrowStr = getTomorrowDateStr();
          document.getElementById('search-bar').value = tomorrowStr;
          document.getElementById('clear-search-btn').style.display = '';
          searchTerm = tomorrowStr;
          fetchBookings(1, currentSort, currentDir, searchTerm, true);
        };
      }
      // Attach click event to Day After Tomorrow card (Bangkok time)
      const dayAfterTomorrowCard = document.getElementById('dayaftertomorrow-card');
      if (dayAfterTomorrowCard) {
        dayAfterTomorrowCard.onclick = function() {
          const dayAfterTomorrowStr = getDayAfterTomorrowDateStr();
          document.getElementById('search-bar').value = dayAfterTomorrowStr;
          document.getElementById('clear-search-btn').style.display = '';
          searchTerm = dayAfterTomorrowStr;
          fetchBookings(1, currentSort, currentDir, searchTerm, true);
        };
      }
    }

    function renderPagination() {
      const controls = document.getElementById('pagination-controls');
      const totalPages = Math.ceil(totalRows / rowsPerPage);
      if (totalPages <= 1) {
        controls.innerHTML = '';
        return;
      }
      let html = '';
      html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="gotoPage(${currentPage - 1})">Prev</button> `;
      // Show up to 5 page numbers, centered on current page
      let start = Math.max(1, currentPage - 2);
      let end = Math.min(totalPages, currentPage + 2);
      if (currentPage <= 3) end = Math.min(5, totalPages);
      if (currentPage >= totalPages - 2) start = Math.max(1, totalPages - 4);
      for (let i = start; i <= end; i++) {
        html += `<button ${i === currentPage ? 'disabled style="font-weight:bold;background:#bbdefb;color:#0d47a1;"' : ''} onclick="gotoPage(${i})">${i}</button> `;
      }
      html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="gotoPage(${currentPage + 1})">Next</button>`;
      controls.innerHTML = html;
    }

    function gotoPage(page) {
      const totalPages = Math.ceil(totalRows / rowsPerPage);
      if (page < 1 || page > totalPages) return;
      fetchBookings(page, currentSort, currentDir, searchTerm);
    }

    // Toggle and call function
    window.handleToggle = async function(column, bookingId, btn) {
      // Find the booking row data
      const booking = bookingsData.find(b => b.booking_number == bookingId);
      if (!booking) return alert('Booking not found.');

      const current = (btn.textContent === '✅');
      const newValue = !current;

      // Business rule: Customer can only be set to true if OP is true
      if (column === 'customer' && newValue === true && !(booking.op === true || booking.op === 1 || booking.op === '1' || booking.op === 'true')) {
        alert('Cannot set Customer ✅ unless OP is already ✅.');
        return;
      }

      // Optionally, add similar rules for other columns if needed

      // Send PATCH request to backend
      btn.disabled = true;
      try {
        const res = await fetch(`/api/bookings/${bookingId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ column, value: newValue })
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
          throw new Error(data.error || 'Failed to update');
        }
        // Update local data and UI
        booking[column] = newValue;
        btn.textContent = newValue ? '✅' : '❌';
      btn.className = newValue ? 'icon-btn icon-true' : 'icon-btn icon-false';
      btn.title = newValue ? 'Yes' : 'No';
      } catch (err) {
        alert('Failed to update: ' + (err.message || 'Unknown error'));
      } finally {
        btn.disabled = false;
      }
    }
    // Add button styles
    const style = document.createElement('style');
    style.innerHTML = `.icon-btn { background: none; border: none; cursor: pointer; font-size: 1.2em; font-weight: bold; padding: 0; margin: 0; }
    .icon-btn.icon-true { color: #388e3c; }
    .icon-btn.icon-false { color: #d32f2f; }
    .icon-btn:focus { outline: 2px solid #1976d2; }`;
    document.head.appendChild(style);
    function updateSortIndicators() {
      const ths = document.querySelectorAll('#bookings-table th[data-col]');
      ths.forEach(th => {
        const col = th.getAttribute('data-col');
        th.textContent = th.textContent.replace(/\s*[▲▼]$/, ''); // Remove old arrow
        if (col === currentSort) {
          th.textContent += currentDir === 'asc' ? ' ▲' : ' ▼';
        }
      });
    }
    document.querySelectorAll('#bookings-table th[data-col]').forEach(th => {
      th.style.cursor = 'pointer';
      th.addEventListener('click', function() {
        const col = th.getAttribute('data-col');
        if (col === currentSort) {
          currentDir = currentDir === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort = col;
          currentDir = 'asc';
        }
        fetchBookings(1, currentSort, currentDir, searchTerm);
      });
    });
    document.getElementById('search-bar').addEventListener('input', function(e) {
      searchTerm = e.target.value;
      fetchBookings(1, currentSort, currentDir, searchTerm, true);
      // Show/hide clear button
      document.getElementById('clear-search-btn').style.display = e.target.value ? '' : 'none';
    });
    // Clear search button logic
    document.getElementById('clear-search-btn').addEventListener('click', function() {
      document.getElementById('search-bar').value = '';
      searchTerm = '';
      fetchBookings(1, currentSort, currentDir, '', false);
      this.style.display = 'none';
      if (accountingTableContainer.style.display !== 'none') {
        accountingSearch = '';
        fetchAccounting(1, accountingSort, accountingDir, '');
      }
    });
    // Initial fetch
    fetchBookings();
    // Helper to get tomorrow's date in YYYY-MM-DD (Bangkok time, always based on currentBangkokDate)
    function getTomorrowDateStr() {
      if (!currentBangkokDate) updateBangkokDateTime();
      const tomorrow = new Date(currentBangkokDate);
      tomorrow.setDate(tomorrow.getDate() + 1);
      // Use Bangkok time for formatting
      return tomorrow.toLocaleDateString('en-CA', { timeZone: 'Asia/Bangkok' });
    }
    // Helper to get day after tomorrow's date in YYYY-MM-DD (Bangkok time, always based on currentBangkokDate)
    function getDayAfterTomorrowDateStr() {
      if (!currentBangkokDate) updateBangkokDateTime();
      const dayAfterTomorrow = new Date(currentBangkokDate);
      dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
      // Use Bangkok time for formatting
      return dayAfterTomorrow.toLocaleDateString('en-CA', { timeZone: 'Asia/Bangkok' });
    }
    window.addEventListener('resize', () => {
      const cardsContainer = document.getElementById('booking-cards-container');
      if (cardsContainer) {
        cardsContainer.style.display = window.innerWidth <= 700 ? 'block' : 'none';
      }
    });
    // Copy notification text logic
    window.handleCopy = function(btn) {
      const booking = JSON.parse(btn.getAttribute('data-booking').replace(/&#39;/g, "'"));
      const text = generateNotificationText(booking);
      navigator.clipboard.writeText(text).then(() => {
        btn.textContent = '✅ Copied!';
        setTimeout(() => { btn.textContent = '📋 Copy'; }, 1200);
      });
    }
    // Notification text generator (matches NotificationManager.constructNotificationMessage)
    function generateNotificationText(b) {
      const tourDate = b.tour_date ? new Date(b.tour_date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: '2-digit' }) : 'N/A';
      const adult = parseInt(b.adult, 10) || 0;
      const child = parseInt(b.child, 10) || 0;
      const infant = parseInt(b.infant, 10) || 0;
      const parts = [];
      parts.push(`${adult} Adult${adult === 1 ? '' : 's'}`);
      if (child > 0) parts.push(`${child} Child${child === 1 ? '' : 'ren'}`);
      if (infant > 0) parts.push(`${infant} Infant${infant === 1 ? '' : 's'}`);
      const paxString = parts.join(', ');
      const totalPax = adult + child + infant;
      const bookingNumber = b.booking_number;
      const program = b.program;
      const customerName = b.customer_name;
      const hotel = b.hotel;
      const phoneNumber = b.phone_number || '';
      return `Please confirm the *pickup time* for this booking:\n\n` +
        `Booking no : ${bookingNumber}\n` +
        `Tour date : ${tourDate}\n` +
        `Program : ${program}\n` +
        `Name : ${customerName}\n` +
        `Pax : ${paxString} (Total: ${totalPax})\n` +
        `Hotel : ${hotel}\n` +
        `Phone Number : ${phoneNumber}\n` +
        `Cash on tour : None\n\n` +
        `Please mentioned if there is any additional charge for transfer collect from customer`;
    }

    // --- ACCOUNTING TABLE LOGIC ---
    let accountingData = [];
    let accountingTotalRows = 0;
    let accountingCurrentPage = 1;
    let accountingSort = 'tour_date';
    let accountingDir = 'desc';
    let accountingSearch = '';
    const accountingRowsPerPage = 20;
    let accountingSummaryData = null;

    function renderAccountingSummary(data) {
      // Always use the original summary data for all bookings, not filtered
      accountingSummaryData = data;
      function statCard(label, total, opNotSentPaid, color, bg, border, totalClass, id = "") {
        return `
        <div class="p-4 rounded-lg ${bg} shadow-sm border ${border} flex flex-col items-center justify-center cursor-pointer" id="${id}">
          <p class="${color} font-semibold mb-2 text-lg">${label}</p>
          <div class="flex flex-wrap justify-center gap-x-4 gap-y-2 text-gray-800">
            <span class="font-medium">Total: <span class="font-bold ${totalClass}">${total}</span></span>
            <span>|</span>
            <span class="text-indigo-700 font-medium">PAID: <span class="font-bold text-indigo-800">${Number(opNotSentPaid).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span></span>
          </div>
        </div>`;
      }
      document.getElementById('accounting-summary').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6 text-sm md:text-base">
          ${statCard('Last Month', data.lastMonthCount, data.lastMonthOpNotSentPaid, 'text-indigo-700', 'bg-indigo-50', 'border-indigo-100', 'text-indigo-800', 'last-month-card')}
          ${statCard('This Month', data.thisMonthCount, data.thisMonthOpNotSentPaid, 'text-teal-700', 'bg-teal-50', 'border-teal-100', 'text-teal-800', 'this-month-card')}
        </div>
        <div class="flex justify-end mt-4">
          <span class="text-xs text-gray-500">Showing <span class="font-semibold text-gray-800">${accountingData.length}</span> of <span class="font-semibold text-gray-800">${accountingTotalRows}</span> results <span class="text-xs text-gray-400 ml-1">(Page ${accountingCurrentPage})</span></span>
        </div>
      `;
      // Add click handlers for filtering (only filter table, not summary)
      setTimeout(() => {
        const lastMonthCard = document.getElementById('last-month-card');
        const thisMonthCard = document.getElementById('this-month-card');
        function getBangkokDate(year, month, day) {
          // month is 0-based
          const utc = Date.UTC(year, month, day);
          return new Date(utc + 7 * 60 * 60 * 1000);
        }
        if (lastMonthCard) {
          lastMonthCard.onclick = function() {
            const now = new Date();
            const thisMonthStart = getBangkokDate(now.getFullYear(), now.getMonth(), 1);
            const lastMonthStart = getBangkokDate(now.getFullYear(), now.getMonth() - 1, 1);
            const lastMonthStartStr = lastMonthStart.toISOString().slice(0, 10);
            const thisMonthStartStr = thisMonthStart.toISOString().slice(0, 10);
            accountingSearch = `date:${lastMonthStartStr},${thisMonthStartStr}`;
            document.getElementById('search-bar').value = '';
            fetchAccounting(1, accountingSort, accountingDir, accountingSearch, true);
          };
        }
        if (thisMonthCard) {
          thisMonthCard.onclick = function() {
            const now = new Date();
            const thisMonthStart = getBangkokDate(now.getFullYear(), now.getMonth(), 1);
            const nextMonthStart = getBangkokDate(now.getFullYear(), now.getMonth() + 1, 1);
            const thisMonthStartStr = thisMonthStart.toISOString().slice(0, 10);
            const nextMonthStartStr = nextMonthStart.toISOString().slice(0, 10);
            accountingSearch = `date:${thisMonthStartStr},${nextMonthStartStr}`;
            document.getElementById('search-bar').value = '';
            fetchAccounting(1, accountingSort, accountingDir, accountingSearch, true);
          };
        }
      }, 0);
    }

    async function fetchAccounting(page = 1, sort = accountingSort, dir = accountingDir, search = accountingSearch, keepSummary = false) {
      const tbody = document.getElementById('accounting-body');
      try {
        const params = new URLSearchParams({
          page,
          limit: accountingRowsPerPage,
          sort,
          dir
        });
        if (search) params.append('search', search);
        const res = await fetch(`/api/accounting?${params.toString()}`);
        const data = await res.json();
        if (!data.bookings || !data.bookings.length) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No results found.</td></tr>';
          accountingData = [];
          accountingTotalRows = 0;
          // Always show the original summary, not filtered
          if (accountingSummaryData) {
            document.getElementById('accounting-summary').style.display = '';
            renderAccountingSummary(accountingSummaryData);
          } else {
            document.getElementById('accounting-summary').style.display = '';
            renderAccountingSummary({ lastMonthCount: 0, lastMonthOpNotSentPaid: 0, thisMonthCount: 0, thisMonthOpNotSentPaid: 0 });
          }
          return;
        }
        accountingData = data.bookings;
        accountingTotalRows = data.total || accountingData.length;
        accountingCurrentPage = data.page || 1;
        // Always show the original summary, not filtered
        document.getElementById('accounting-summary').style.display = '';
        if (!accountingSummaryData) {
          renderAccountingSummary({
            lastMonthCount: data.lastMonthCount || 0,
            lastMonthOpNotSentPaid: data.lastMonthOpNotSentPaid || 0,
            thisMonthCount: data.thisMonthCount || 0,
            thisMonthOpNotSentPaid: data.thisMonthOpNotSentPaid || 0
          });
        } else {
          renderAccountingSummary(accountingSummaryData);
        }
        renderAccountingTable();
        renderAccountingPagination();
      } catch (err) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">Failed to load data.</td></tr>';
        if (accountingSummaryData) {
          document.getElementById('accounting-summary').style.display = '';
          renderAccountingSummary(accountingSummaryData);
        } else {
          document.getElementById('accounting-summary').style.display = '';
          renderAccountingSummary({ lastMonthCount: 0, lastMonthOpNotSentPaid: 0, thisMonthCount: 0, thisMonthOpNotSentPaid: 0 });
        }
      }
    }
    function renderAccountingTable() {
      const tbody = document.getElementById('accounting-body');
      if (!accountingData.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No results found.</td></tr>';
      } else {
        tbody.innerHTML = accountingData.map(b => `
          <tr>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${b.booking_number || ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">${b.tour_date ? b.tour_date.substring(0, 10) : ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">${b.customer_name || ''}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm">${b.sku || ''}</td>
            <td class="px-4 py-3 text-sm">${b.program || ''}</td>
            <td class="px-4 py-3 text-sm">${b.hotel || ''}</td>
            <td class="px-4 py-3 text-sm accounting-paid-cell" data-booking="${b.booking_number}" tabindex="0">${b.paid !== null && b.paid !== undefined ? Number(b.paid).toFixed(2) : '<span class=\'text-gray-400\'>Click to add</span>'}</td>
            <td class="px-4 py-3 text-center"><button class="cancel-btn" title="Cancel booking" data-booking="${b.booking_number}">❌</button></td>
          </tr>
        `).join('');
        // Add inline edit handlers
        setTimeout(() => {
          document.querySelectorAll('.accounting-paid-cell').forEach(cell => {
            cell.onclick = function(e) {
              if (cell.querySelector('input')) return;
              const bookingNumber = cell.getAttribute('data-booking');
              const currentValue = cell.textContent.trim() === 'Click to add' ? '' : cell.textContent.trim();
              cell.innerHTML = `<input type='number' step='0.01' min='0' class='border px-2 py-1 w-24' value='${currentValue}' autofocus />`;
              const input = cell.querySelector('input');
              input.focus();
              input.select();
              input.onblur = input.onkeydown = function(ev) {
                if (ev.type === 'keydown' && ev.key !== 'Enter') return;
                const newValue = input.value.trim();
                if (newValue === '' || isNaN(newValue)) {
                  cell.innerHTML = `<span class='text-gray-400'>Click to add</span>`;
                  return;
                }
                cell.innerHTML = `<span class='text-gray-400'>Saving...</span>`;
                fetch(`/api/accounting/${bookingNumber}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ paid: parseFloat(newValue).toFixed(2) })
                }).then(r => r.json()).then(data => {
                  if (data.success) {
                    fetchAccounting(accountingCurrentPage, accountingSort, accountingDir, accountingSearch);
                  } else {
                    cell.innerHTML = `<span class='text-red-500'>Error</span>`;
                  }
                }).catch(() => {
                  cell.innerHTML = `<span class='text-red-500'>Error</span>`;
                });
              };
            };
            cell.onkeydown = function(e) { if (e.key === 'Enter') cell.click(); };
          });
          // Add cancel button handlers
          document.querySelectorAll('.cancel-btn').forEach(btn => {
            btn.onclick = function() {
              const bookingNumber = btn.getAttribute('data-booking');
              if (!confirm('Are you sure you want to cancel and remove this booking?')) return;
              btn.disabled = true;
              fetch(`/api/accounting/${bookingNumber}`, {
                method: 'DELETE'
              }).then(r => r.json()).then(data => {
                if (data.success) {
                  fetchAccounting(accountingCurrentPage, accountingSort, accountingDir, accountingSearch);
                } else {
                  alert('Failed to cancel: ' + (data.error || 'Unknown error'));
                  btn.disabled = false;
                }
              }).catch(() => {
                alert('Failed to cancel (network error)');
                btn.disabled = false;
              });
            };
          });
        }, 0);
      }
    }
    function renderAccountingPagination() {
      const controls = document.getElementById('accounting-pagination-controls');
      const totalPages = Math.ceil(accountingTotalRows / accountingRowsPerPage);
      if (totalPages <= 1) {
        controls.innerHTML = '';
        return;
      }
      let html = '';
      html += `<button ${accountingCurrentPage === 1 ? 'disabled' : ''} onclick="gotoAccountingPage(${accountingCurrentPage - 1})">Prev</button> `;
      let start = Math.max(1, accountingCurrentPage - 2);
      let end = Math.min(totalPages, accountingCurrentPage + 2);
      if (accountingCurrentPage <= 3) end = Math.min(5, totalPages);
      if (accountingCurrentPage >= totalPages - 2) start = Math.max(1, totalPages - 4);
      for (let i = start; i <= end; i++) {
        html += `<button ${i === accountingCurrentPage ? 'disabled style="font-weight:bold;background:#bbdefb;color:#0d47a1;"' : ''} onclick="gotoAccountingPage(${i})">${i}</button> `;
      }
      html += `<button ${accountingCurrentPage === totalPages ? 'disabled' : ''} onclick="gotoAccountingPage(${accountingCurrentPage + 1})">Next</button>`;
      controls.innerHTML = html;
    }
    window.gotoAccountingPage = function(page) {
      const totalPages = Math.ceil(accountingTotalRows / accountingRowsPerPage);
      if (page < 1 || page > totalPages) return;
      fetchAccounting(page, accountingSort, accountingDir, accountingSearch);
    }
    // Toggle logic
    const dashboardBtn = document.getElementById('toggle-dashboard');
    const bookingsBtn = document.getElementById('toggle-bookings');
    const accountingBtn = document.getElementById('toggle-accounting');
    const dashboardSection = document.getElementById('dashboard-section');
    const bookingsTableSection = document.querySelector('.bookings-table-container');
    const summarySection = document.getElementById('table-summary');
    const accountingTableContainer = document.getElementById('accounting-table-container');
    const searchBarSection = document.querySelector('.mb-6');
    const programsBtn = document.getElementById('toggle-programs');
    const programsSection = document.getElementById('programs-section');
    const addProgramBtn = document.getElementById('add-program-btn');

    // On page load, show Dashboard by default
    window.addEventListener('DOMContentLoaded', () => {
      dashboardSection.style.display = '';
      bookingsTableSection.style.display = 'none';
      summarySection.style.display = 'none';
      accountingTableContainer.style.display = 'none';
      searchBarSection.style.display = 'none';
      document.getElementById('pagination-controls').style.display = 'none';
      dashboardBtn.className = 'px-4 py-2 rounded font-semibold bg-blue-600 text-white';
      bookingsBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      accountingBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      fetchDashboardAnalytics();
    });

    dashboardBtn.onclick = () => {
      dashboardBtn.className = 'px-4 py-2 rounded font-semibold bg-blue-600 text-white';
      bookingsBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      accountingBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      programsBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      dashboardSection.style.display = '';
      bookingsTableSection.style.display = 'none';
      summarySection.style.display = 'none';
      accountingTableContainer.style.display = 'none';
      searchBarSection.style.display = 'none';
      document.getElementById('pagination-controls').style.display = 'none';
      programsSection.style.display = 'none';
      fetchDashboardAnalytics();
    };
    bookingsBtn.onclick = () => {
      dashboardBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      bookingsBtn.className = 'px-4 py-2 rounded font-semibold bg-blue-600 text-white';
      accountingBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      programsBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      dashboardSection.style.display = 'none';
      bookingsTableSection.style.display = '';
      summarySection.style.display = '';
      accountingTableContainer.style.display = 'none';
      searchBarSection.style.display = '';
      document.getElementById('pagination-controls').style.display = '';
      programsSection.style.display = 'none';
      fetchBookings();
    };
    accountingBtn.onclick = () => {
      dashboardBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      bookingsBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      accountingBtn.className = 'px-4 py-2 rounded font-semibold bg-blue-600 text-white';
      programsBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      dashboardSection.style.display = 'none';
      bookingsTableSection.style.display = 'none';
      summarySection.style.display = 'none';
      accountingTableContainer.style.display = '';
      searchBarSection.style.display = '';
      document.getElementById('pagination-controls').style.display = 'none';
      programsSection.style.display = 'none';
      fetchAccounting();
    };
    programsBtn.onclick = () => {
      dashboardBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      bookingsBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      programsBtn.className = 'px-4 py-2 rounded font-semibold bg-blue-600 text-white';
      accountingBtn.className = 'px-4 py-2 rounded font-semibold bg-gray-200 text-gray-800';
      dashboardSection.style.display = 'none';
      bookingsTableSection.style.display = 'none';
      summarySection.style.display = 'none';
      accountingTableContainer.style.display = 'none';
      programsSection.style.display = '';
      searchBarSection.style.display = 'none';
      document.getElementById('pagination-controls').style.display = 'none';
      fetchRatesAndPrograms();
    };
    // Search bar integration
    document.getElementById('search-bar').addEventListener('input', function(e) {
      if (accountingTableContainer.style.display !== 'none') {
        accountingSearch = e.target.value;
        fetchAccounting(1, accountingSort, accountingDir, accountingSearch);
      }
    });
    // Sort integration for accounting table
    document.querySelectorAll('#accounting-table th[data-col]').forEach(th => {
      th.style.cursor = 'pointer';
      th.addEventListener('click', function() {
        const col = th.getAttribute('data-col');
        if (col === accountingSort) {
          accountingDir = accountingDir === 'asc' ? 'desc' : 'asc';
        } else {
          accountingSort = col;
          accountingDir = 'asc';
        }
        fetchAccounting(1, accountingSort, accountingDir, accountingSearch);
      });
    });
    function updateBangkokDateTime() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const bangkok = new Date(utc + 7 * 60 * 60 * 1000);
      currentBangkokDate = new Date(bangkok.getFullYear(), bangkok.getMonth(), bangkok.getDate()); // midnight Bangkok
      const dateStr = bangkok.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
      const timeStr = bangkok.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      document.getElementById('bangkok-datetime').textContent = `${dateStr} — ${timeStr} (Bangkok Time)`;
    }
    setInterval(updateBangkokDateTime, 1000);
    updateBangkokDateTime();

    function fetchDashboardAnalytics() {
      const period = document.getElementById('dashboard-period').value;
      // Show loading states
      document.getElementById('dashboard-total-bookings').textContent = '...';
      document.getElementById('dashboard-new-bookings').textContent = '...';
      document.getElementById('dashboard-total-earnings').textContent = '...';
      document.getElementById('dashboard-done').textContent = '...';
      document.getElementById('dashboard-booked').textContent = '...';
      document.getElementById('dashboard-progress').style.width = '0%';
      document.getElementById('dashboard-revenue-list').innerHTML = '<span class="text-gray-400">Loading...</span>';
      document.getElementById('dashboard-top-destinations').innerHTML = '<span class="text-gray-400">Loading...</span>';
      fetch(`/api/dashboard?period=${period}`)
        .then(res => res.json())
        .then(data => {
          // Total Bookings
          document.getElementById('dashboard-total-bookings').textContent = data.totalBookings.toLocaleString();
          // New Bookings
          document.getElementById('dashboard-new-bookings').textContent = data.newBookings.toLocaleString();
          // Total Earnings
          document.getElementById('dashboard-total-earnings').textContent = data.totalEarnings.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
          // Done/Booked
          document.getElementById('dashboard-done').textContent = data.done.toLocaleString();
          document.getElementById('dashboard-booked').textContent = data.booked.toLocaleString();
          const total = data.done + data.booked;
          const percent = total === 0 ? 0 : Math.round((data.done / total) * 100);
          document.getElementById('dashboard-progress').style.width = percent + '%';
          // Revenue by Day
          if (data.revenueByDay && data.revenueByDay.length) {
            document.getElementById('dashboard-revenue-list').innerHTML = data.revenueByDay.map(row =>
              `<div class='flex justify-between'><span>${row.day}</span><span class='font-semibold text-green-700'>${Number(row.revenue).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span></div>`
            ).join('');
          } else {
            document.getElementById('dashboard-revenue-list').innerHTML = '<span class="text-gray-400">No data</span>';
          }
          // Top Destinations
          if (data.topDestinations && data.topDestinations.length) {
            document.getElementById('dashboard-top-destinations').innerHTML = data.topDestinations.map((row, i) =>
              `<div class='flex justify-between'><span>${i+1}. ${row.program || '(No Program)'}</span><span class='font-semibold text-indigo-700'>${row.count}</span></div>`
            ).join('');
          } else {
            document.getElementById('dashboard-top-destinations').innerHTML = '<span class="text-gray-400">No data</span>';
          }
          // Percent changes
          const bookingsChange = document.getElementById('dashboard-total-bookings-change');
          const newChange = document.getElementById('dashboard-new-bookings-change');
          const earningsChange = document.getElementById('dashboard-total-earnings-change');
          if (data.percentNew !== null && data.percentNew !== undefined) {
            const up = data.percentNew >= 0;
            newChange.innerHTML = `<span class='${up ? 'text-green-600' : 'text-red-600'}'>${up ? '+' : ''}${data.percentNew.toFixed(2)}%</span> vs last month`;
          } else {
            newChange.textContent = '';
          }
          if (data.percentEarnings !== null && data.percentEarnings !== undefined) {
            const up = data.percentEarnings >= 0;
            earningsChange.innerHTML = `<span class='${up ? 'text-green-600' : 'text-red-600'}'>${up ? '+' : ''}${data.percentEarnings.toFixed(2)}%</span> vs last month`;
          } else {
            earningsChange.textContent = '';
          }
          bookingsChange.textContent = '';
        })
        .catch(err => {
          document.getElementById('dashboard-total-bookings').textContent = '-';
          document.getElementById('dashboard-new-bookings').textContent = '-';
          document.getElementById('dashboard-total-earnings').textContent = '-';
          document.getElementById('dashboard-done').textContent = '-';
          document.getElementById('dashboard-booked').textContent = '-';
          document.getElementById('dashboard-progress').style.width = '0%';
          document.getElementById('dashboard-revenue-list').innerHTML = '<span class="text-red-500">Error loading data</span>';
          document.getElementById('dashboard-top-destinations').innerHTML = '<span class="text-red-500">Error loading data</span>';
          document.getElementById('dashboard-total-bookings-change').textContent = '';
          document.getElementById('dashboard-new-bookings-change').textContent = '';
          document.getElementById('dashboard-total-earnings-change').textContent = '';
        });
    }
    document.getElementById('dashboard-period').addEventListener('change', fetchDashboardAnalytics);

    let allRates = [];
    function fetchRatesAndPrograms() {
      // Fetch rates first
      fetch('/api/rates')
        .then(res => res.json())
        .then(data => {
          allRates = data.rates || [];
          fetchPrograms();
        });
    }
    function fetchPrograms() {
      const tbody = document.getElementById('programs-table-body');
      tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;">Loading...</td></tr>';
      fetch('/api/tours')
        .then(res => res.json())
        .then(data => {
          if (!data.tours || !data.tours.length) {
            tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;">No programs found.</td></tr>';
            return;
          }
          tbody.innerHTML = '';
          data.tours.forEach(row => tbody.appendChild(renderProgramRow(row)));
        })
        .catch(() => {
          tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:red;">Failed to load programs.</td></tr>';
        });
    }

    function renderProgramRow(row, isEdit = false) {
      const tr = document.createElement('tr');
      if (isEdit) {
        // Build rate dropdown options
        let rateOptions = `<option value="">-- Add New Item --</option>`;
        allRates.forEach(rate => {
          rateOptions += `<option value="${rate.name.replace(/"/g, '&quot;') }"${row.rate === rate.name ? ' selected' : ''}>${rate.name}</option>`;
        });
        tr.innerHTML = `
          <td><input class='border px-2 py-1 w-24' value="${row.sku || ''}" /></td>
          <td><input class='border px-2 py-1 w-24' value="${row.id || ''}" /></td>
          <td><input class='border px-2 py-1 w-40' value="${row.program || ''}" /></td>
          <td>
            <select class='border px-2 py-1 w-32 rate-select'>${rateOptions}</select>
            <div class='rate-new-fields' style='display:none;'>
              <input type='text' class='border px-2 py-1 w-32 rate-name-input' placeholder='New rate name' />
              <input type='number' step='0.01' class='border px-2 py-1 w-20 rate-adult-input' placeholder='Net Adult' />
              <input type='number' step='0.01' class='border px-2 py-1 w-20 rate-child-input' placeholder='Net Child' />
              <button class='add-rate-btn px-2 py-1 bg-green-600 text-white rounded'>Save</button>
            </div>
          </td>
          <td><input type='number' step='0.01' class='border px-2 py-1 w-20 net-adult-input' value="${row.net_adult || ''}" /></td>
          <td><input type='number' step='0.01' class='border px-2 py-1 w-20 net-child-input' value="${row.net_child || ''}" /></td>
          <td><input type='checkbox' ${row.np ? 'checked' : ''} /></td>
          <td><input type='number' step='0.01' class='border px-2 py-1 w-20' value="${row.np_adult || ''}" ${row.np ? '' : 'disabled'} /></td>
          <td><input type='number' step='0.01' class='border px-2 py-1 w-20' value="${row.np_child || ''}" ${row.np ? '' : 'disabled'} /></td>
          <td><input class='border px-2 py-1 w-32' value="${row.remark || ''}" /></td>
          <td>
            <button class='save-btn px-2 py-1 bg-green-600 text-white rounded mr-2'>Save</button>
            <button class='cancel-btn px-2 py-1 bg-gray-400 text-white rounded'>Cancel</button>
          </td>
        `;
        // Enable/disable NP fields based on checkbox
        const npCheckbox = tr.querySelector('td:nth-child(7) input[type=checkbox]');
        const npAdultInput = tr.querySelector('td:nth-child(8) input');
        const npChildInput = tr.querySelector('td:nth-child(9) input');
        npCheckbox.onchange = () => {
          npAdultInput.disabled = npChildInput.disabled = !npCheckbox.checked;
        };
        // Rate select/input logic
        const rateSelect = tr.querySelector('.rate-select');
        const rateNewFields = tr.querySelector('.rate-new-fields');
        const rateNameInput = tr.querySelector('.rate-name-input');
        const rateAdultInput = tr.querySelector('.rate-adult-input');
        const rateChildInput = tr.querySelector('.rate-child-input');
        const addRateBtn = tr.querySelector('.add-rate-btn');
        const netAdultInput = tr.querySelector('.net-adult-input');
        const netChildInput = tr.querySelector('.net-child-input');
        rateSelect.onchange = () => {
          if (rateSelect.value === '') {
            rateSelect.style.display = 'none';
            rateNewFields.style.display = '';
            rateNameInput.value = '';
            rateAdultInput.value = '';
            rateChildInput.value = '';
            rateNameInput.focus();
          } else {
            // Auto-fill net prices from selected rate
            const selectedRate = allRates.find(r => r.name === rateSelect.value);
            if (selectedRate) {
              netAdultInput.value = selectedRate.net_adult;
              netChildInput.value = selectedRate.net_child;
            }
          }
        };
        addRateBtn.onclick = () => {
          const name = rateNameInput.value.trim();
          const net_adult = rateAdultInput.value.trim();
          const net_child = rateChildInput.value.trim();
          if (!name || net_adult === '' || net_child === '') {
            alert('Please fill in all rate fields.');
            return;
          }
          addRateBtn.disabled = true;
          fetch('/api/rates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, net_adult, net_child })
          })
            .then(res => res.json())
            .then(data => {
              if (data.rate) {
                allRates.push(data.rate);
                rateSelect.innerHTML += `<option value="${data.rate.name}">${data.rate.name}</option>`;
                rateSelect.value = data.rate.name;
                netAdultInput.value = data.rate.net_adult;
                netChildInput.value = data.rate.net_child;
                row.rate = data.rate.name;
                rateSelect.style.display = '';
                rateNewFields.style.display = 'none';
              } else {
                alert('Failed to add rate.');
              }
            })
            .catch(() => alert('Failed to add rate.'))
            .finally(() => { addRateBtn.disabled = false; });
        };
        // Save/cancel handlers
        tr.querySelector('.save-btn').onclick = () => saveProgramRow(tr, row);
        tr.querySelector('.cancel-btn').onclick = () => fetchRatesAndPrograms();
      } else {
        tr.innerHTML = `
          <td>${row.sku || ''}</td>
          <td>${row.id || ''}</td>
          <td>${row.program || ''}</td>
          <td>${row.rate || ''}</td>
          <td>${row.net_adult || ''}</td>
          <td>${row.net_child || ''}</td>
          <td>${row.np ? '✅' : '❌'}</td>
          <td>${row.np ? (row.np_adult || '') : ''}</td>
          <td>${row.np ? (row.np_child || '') : ''}</td>
          <td>${row.remark || ''}</td>
          <td>
            <button class='edit-btn px-2 py-1 bg-blue-600 text-white rounded mr-2'>Edit</button>
            <button class='delete-btn px-2 py-1 bg-red-600 text-white rounded'>Delete</button>
          </td>
        `;
        tr.querySelector('.edit-btn').onclick = () => {
          const editRow = { ...row };
          tr.replaceWith(renderProgramRow(editRow, true));
        };
        tr.querySelector('.delete-btn').onclick = () => deleteProgramRow(row);
      }
      return tr;
    }

    addProgramBtn.onclick = () => {
      const tbody = document.getElementById('programs-table-body');
      const newRow = {
        sku: '', id: '', program: '', rate: '', net_adult: '', net_child: '', np: false, np_adult: '', np_child: '', remark: ''
      };
      tbody.prepend(renderProgramRow(newRow, true));
    };

    function saveProgramRow(tr, oldRow) {
      const inputs = tr.querySelectorAll('input');
      const [sku, id, program, rate, net_adult, net_child, np, np_adult, np_child, remark] = [
        inputs[0].value, inputs[1].value, inputs[2].value, inputs[3].value,
        inputs[4].value, inputs[5].value, inputs[6].checked,
        inputs[7].value, inputs[8].value, inputs[9].value
      ];
      // Frontend validation for required fields (id is optional)
      if (!sku || !program || !rate || net_adult === '' || net_child === '') {
        alert('Please fill in all required fields: SKU, Program, Rate, Net Adult, Net Child.');
        return;
      }
      const body = {
        sku, id, program, rate,
        net_adult: net_adult ? parseFloat(net_adult) : 0,
        net_child: net_child ? parseFloat(net_child) : 0,
        np,
        np_adult: np ? (np_adult ? parseFloat(np_adult) : 0) : null,
        np_child: np ? (np_child ? parseFloat(np_child) : 0) : null,
        remark
      };
      const method = oldRow && oldRow.sku ? 'PUT' : 'POST';
      fetch('/api/tours', {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
        .then(res => res.json())
        .then(() => fetchPrograms())
        .catch(() => alert('Failed to save.'));
    }

    function deleteProgramRow(row) {
      if (!confirm('Delete this program?')) return;
      fetch('/api/tours', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: row.id, sku: row.sku, rate: row.rate })
      })
        .then(res => res.json())
        .then(() => fetchPrograms())
        .catch(() => alert('Failed to delete.'));
    }
  </script>
</body>
</html>